name: "Prepare Open Community Build"
description: "Ensure compiler version is published, resolve url for custom Maven repository"
inputs:
  scala-version:
    description: "Scala version to check"
  repository-url:
    description: "GitHub repository URL for compiler to build"
    required: true
  repository-branch:
    description: "GitHub repository branch for compiler to build"
    required: true
outputs:
  scala-version:
    description: "Effective Scala version, input value of scala-version if using published version or version of builded compiler"
    value: ${{ steps.calc-version.outputs.effective-scala-version }}
  maven-repo-url:
    description: "Effective Maven repository subdirectory to use"
    value: ${{ steps.calc-version.outputs.effective-maven-url }}

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4
      with:
        repository: ${{ inputs.repository-url }}
        ref: ${{ inputs.repository-branch }}
        path: "compiler"

    - name: Calculate version if missing
      id: calc-version
      shell: bash
      run: |
        scalaVersion=${{ inputs.scala-version }}
        if [[ -z $scalaVersion ]]; then
          cd compiler
          git --no-pager log -1
          commitHash=$(git rev-parse --short=7 HEAD)
          commitDate=$(git show -s --format=%cd --date=format:"%Y%m%d" HEAD)
          baseVersion="$(sbt 'eval Build.baseVersion' | grep 'ans: String =' | xargs | awk '{ print $5 }')"
          # `SNAPSHOT` substring is required to treat compiler as experimental
          # All compilers build from branch are treated experimental
          scalaVersion="${baseVersion}-${commitDate}-${commitHash}-SNAPSHOT"
        fi

        baseMavenRepo="https://scala3.westeurope.cloudapp.azure.com/maven2"
        buildMavenRepo="${baseMavenRepo}/${scalaVersion}"

        echo "Effective Scala version for this build: $scalaVersion"
        echo "effective-scala-version=${scalaVersion}" >> $GITHUB_OUTPUT

        echo "Effective Maven repository for this build: $buildMavenRepo"
        echo "effective-maven-url=${buildMavenRepo}" >> $GITHUB_OUTPUT

    - name: Install coursier
      uses: coursier/setup-action@v1
      with:
        apps: cs
    - name: Check version is published
      shell: bash
      id: check-published
      run: |
        Version="${{ steps.calc-version.outputs.effective-scala-version }}"
        CustomMavenRepo="${{ steps.calc-version.outputs.effective-maven-url }}"
        isPublished=false
        # Download jar instead of checking only for pom to ensure that it's complete
        if cs fetch org.scala-lang:scala3-compiler_3:${Version} -r $CustomMavenRepo ; then
          isPublished=true
        elif [[ ! -z "${{ inputs.scala-version }}" ]]; then
          echo "::error title=Compiler version unavailable::Requested compiler version ${{ inputs.scala-version }} is unavailable" 
          exit 1
        fi
        echo "Can skip compiler build: ${isPublished}"
        echo "is-compiler-published=${isPublished}" >> $GITHUB_OUTPUT

    - name: Build compiler
      uses: addnab/docker-run-action@v3
      if: steps.check-published.outputs.is-compiler-published == 'false'
      with:
        image: "lampepfl/dotty:2024-10-18"
        options: -v ${{ github.workspace }}/compiler:/compiler/
        run: |
          echo '##################################'
          echo "Release Scala in version: ${{ steps.calc-version.outputs.effective-scala-version }}"
          echo "Maven repo at: ${{ steps.calc-version.outputs.effective-maven-url }}"
          echo '##################################'

          cd /compiler/
          PATH="/usr/lib/jvm/java-8-openjdk-amd64/bin:$PATH"

          java -version
          set -x
          sbt \
            'set every publishTo := Some("Community Build Repo" at "${{ steps.calc-version.outputs.effective-maven-url }}")' \
            \;'show scala3-bootstrapped/publishTo' \
            \;'set every version := "${{ steps.calc-version.outputs.effective-scala-version }}"' \
            \;'show scala3-bootstrapped/version' \
            \;"scala3-interfaces/publish" \
            \;"scala3-bootstrapped/publish"
